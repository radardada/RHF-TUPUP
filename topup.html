<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RHF â€” Proses Topup</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body{margin:0;font-family:Inter,system-ui;background:#0f1220;color:#e9ecf5}
    .container{max-width:820px;margin:24px auto;padding:0 20px}
    .card{background:#171a2b;border:1px solid #23263a;border-radius:14px;padding:18px;margin-bottom:20px}
    .logo{text-align:center;margin-bottom:12px}
    .logo img{width:96px;height:96px;object-fit:contain;border-radius:12px;background:#0b0d18}
    .logo h2{margin:10px 0 0;font-size:20px}
    .input{width:100%;padding:12px;border-radius:10px;border:1px solid #23263a;background:#121528;color:#e9ecf5}
    .pkg{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .pkg-item{background:#121528;border:1px solid #23263a;border-radius:12px;padding:12px;cursor:pointer}
    .pkg-item.active{border-color:#00d4a6}
    .chip{padding:8px 12px;border-radius:999px;background:#121528;border:1px solid #23263a;cursor:pointer}
    .chip.active{border-color:#5b8cff}
    .btn{padding:12px 16px;border-radius:10px;background:#5b8cff;color:#fff;font-weight:700;border:0;cursor:pointer}
    .error{color:#ff5b6e;font-weight:600}
    .success{color:#00d4a6;font-weight:600}
  </style>
</head>
<body>
  <div class="container">
    <div class="logo" id="gameHeader"></div>
    <div class="card">
      <h2>Informasi Akun</h2>
      <div id="accountFields"></div>
      <label class="muted">Kontak</label>
      <input id="contact" class="input" placeholder="WhatsApp / Email">
    </div>
    <div class="card">
      <h2>Pilih Paket</h2>
      <div id="packages" class="pkg"></div>
    </div>
    <div class="card">
      <h2>Metode Pembayaran</h2>
      <div id="payMethods"></div>
      <button id="payBtn" class="btn">Bayar Sekarang</button>
      <p id="payMsg"></p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyALIhKFz4bpOPmES6t2fAdx8VMPP0ye1wc",
      authDomain: "rhf-resmi.firebaseapp.com",
      databaseURL: "https://rhf-resmi-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "rhf-resmi",
      storageBucket: "rhf-resmi.firebasestorage.app",
      messagingSenderId: "313439235544",
      appId: "1:313439235544:web:b19a2ad538e34c1fe516ad",
      measurementId: "G-LNCVH73P3X"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const params = new URLSearchParams(location.search);
    const gameKey = params.get('game') || 'ff';
    const userId = params.get('uid') || '-OiaOj6ERcsxHhKRQzSd';

    const GAME_CONFIG = {
      ff:{name:'Free Fire',logo:'https://upload.wikimedia.org/wikipedia/en/c/c5/Logo_of_Garena_Free_Fire.png',
        fields:[{id:'ff_id',label:'Player ID',placeholder:'Contoh: 123456789'}],
        packages:[{id:'ff_50',title:'50 Diamonds',price:9000},{id:'ff_100',title:'100 Diamonds',price:17000}]},
      ml:{name:'Mobile Legends',logo:'https://assets.stickpng.com/images/62061920cdd94000043e3951.png',
        fields:[{id:'ml_id',label:'ID (Server)',placeholder:'Contoh: 12345678 (1234)'}],
        packages:[{id:'ml_86',title:'86 Diamonds',price:20000}]}
    };

    const game = GAME_CONFIG[gameKey];
    document.getElementById('gameHeader').innerHTML = `<img src="${game.logo}" alt="${game.name}"><h2>${game.name}</h2>`;

    const accountFields = document.getElementById('accountFields');
    game.fields.forEach(f=>{
      const div=document.createElement('div');
      div.innerHTML=`<label>${f.label}</label><input id="${f.id}" class="input" placeholder="${f.placeholder}">`;
      accountFields.appendChild(div);
    });

    const packages=document.getElementById('packages');
    game.packages.forEach(p=>{
      const item=document.createElement('div');
      item.className='pkg-item';
      item.innerHTML=`<div>${p.title}</div><div>Rp ${p.price.toLocaleString('id-ID')}</div>`;
      item.addEventListener('click',()=>{ 
        document.querySelectorAll('.pkg-item').forEach(el=>el.classList.remove('active'));
        item.classList.add('active');
        selectedPkg=p;
      });
      packages.appendChild(item);
    });

    const payMethods=document.getElementById('payMethods');
    ['saldo','ewallet','bank'].forEach(m=>{
      const chip=document.createElement('button');
      chip.className='chip'+(m==='saldo'?' active':'');
      chip.textContent=(m==='saldo'?'Saldo RHF':m==='ewallet'?'E-Wallet':'Transfer Bank');
      chip.addEventListener('click',()=>{
        document.querySelectorAll('.chip').forEach(el=>el.classList.remove('active'));
        chip.classList.add('active');
        selectedPay=m;
      });
      payMethods.appendChild(chip);
    });

    let selectedPkg=null;
    let selectedPay='saldo';

    async function getUserSaldo(uid){
      const snap = await get(ref(db,'users/'+uid+'/saldo'));
      return snap.exists()?Number(snap.val()):0;
    }
    async function setUserSaldo(uid,newSaldo){
      await update(ref(db,'users/'+uid),{saldo:newSaldo});
    }

    document.getElementById('payBtn').addEventListener('click',async ()=>{
      const msg=document.getElementById('payMsg');
      msg.textContent='';
      const contact=document.getElementById('contact').value.trim();
      if(!selectedPkg){ msg.textContent='Pilih paket dulu'; msg.className='error'; return; }
      if(!contact){ msg.textContent='Isi kontak'; msg.className='error'; return; }

      const orderId='ORD-'+Math.random().toString(36).slice(2,8).toUpperCase();
      const order={id:orderId,userId,game:gameKey,package:selectedPkg.title,price:selectedPkg.price,contact,payMethod:selectedPay,status:'created',createdAt:Date.now()};
      await set(ref(db,'ORDERS_LOG/'+orderId),order);

      if(selectedPay==='saldo'){
        const saldo=await getUserSaldo(userId);
        if(saldo >= selectedPkg.price){
          const newSaldo = saldo - selectedPkg.price;
          await setUserSaldo(userId,newSaldo);
          order.status='confirmed';
          await set(ref(db,'CONFIRMED/'+orderId),order);
          location.href=`konfirmasi.html?order=${order.id}`;
        }else{
          order.status='saldo_insufficient';
          await set(ref(db,'ADMIN_QUEUE/'+orderId),order);
          msg.textContent='Saldo tidak cukup. Order masuk ke admin.'; msg.className='error';
        }
      }else{
        order.status='waiting_payment';
        await set(ref(db,'ADMIN_QUEUE/'+orderId),order);
        location.href=`tunggu.html?order=${order.id}&method=${selectedPay}&game=${order.game}`;
      }
    });
  </script>
</body>
</html>
